<div class="container">
  <div class="header-actions">
    <button mat-raised-button color="primary" (click)="goToHome()">
      <mat-icon>arrow_back</mat-icon>
      Volver al inicio
    </button>
  </div>

  @if (repositories().username) {
  <h1>Repositorios de {{ repositories().username }}</h1>
  }

  <!-- Añadimos controles para los parámetros de consulta -->
  @if (!isLoading() && repositories().repositories.length) {
  <div class="query-controls">
    <div class="filters-row">
      <mat-form-field appearance="outline">
        <mat-label>Ordenar por</mat-label>
        <mat-select
          [value]="queryParams().sort"
          (selectionChange)="changeSort($event.value)"
        >
          @for (option of sortOptions; track option.value) {
          <mat-option [value]="option.value">{{ option.viewValue }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Orden</mat-label>
        <mat-select
          [value]="queryParams().direction"
          (selectionChange)="changeOrder($event.value)"
        >
          @for (option of orderOptions; track option.value) {
          <mat-option [value]="option.value">{{ option.viewValue }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Resultados por página</mat-label>
        <mat-select
          [value]="queryParams().per_page"
          (selectionChange)="changePerPage($event.value)"
        >
          @for (option of perPageOptions; track $index) {
          <mat-option [value]="option">{{ option }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
  </div>
  } @if (isLoading()) {
  <div class="loading-spinner">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando repositorios...</p>
  </div>
  } @if (!isLoading() && repositories().repositories.length) {
  <div class="repositories-container">
    @for (repo of repositories().repositories; track $index) {
    <mat-card class="repository-card">
      <mat-card-header>
        <mat-card-title>
          <a [href]="repo.url" target="_blank" rel="noopener noreferrer">{{
            repo.name
          }}</a>
        </mat-card-title>
        <mat-card-subtitle>{{ repo.full_name }}</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        @if (repo.description) {
        <p>{{ repo.description }}</p>
        } @else {
        <p class="no-description">Sin descripción</p>
        }

        <div class="repo-stats">
          <div class="stat" matTooltip="Estrellas">
            <mat-icon>star</mat-icon>
            <span>{{ repo.stars }}</span>
          </div>
          <div class="stat" matTooltip="Bifurcaciones">
            <mat-icon>fork_right</mat-icon>
            <span>{{ repo.forks }}</span>
          </div>
          @if (repo.language) {
          <div class="stat" matTooltip="Lenguaje principal">
            <app-language-icon
              [language]="repo.language"
              [size]="{ width: 20, height: 20 }"
            ></app-language-icon>
            <span>{{ repo.language }}</span>
          </div>
          }
        </div>

        <mat-divider></mat-divider>

        <div class="repo-dates">
          <p>
            <strong>Creado:</strong>
            {{ repo.created_at | date : "MMM dd, yyyy" }}
          </p>

          <p>
            <strong>Última actualización:</strong>
            {{ repo.updated_at | date : "MMM dd, yyyy" }}
          </p>
        </div>
      </mat-card-content>

      <mat-card-actions>
        <a
          mat-button
          color="primary"
          [href]="repo.url"
          target="_blank"
          rel="noopener noreferrer"
        >
          <mat-icon>open_in_new</mat-icon>
          VER REPOSITORIO
        </a>
      </mat-card-actions>
    </mat-card>
    }
  </div>

  <!-- Añadimos el paginador personalizado -->
  @if (!isLoading() && repositories().repositories.length) {

  <app-paginator
    [currentPage]="queryParams().page"
    [hasNextPage]="hasNextPage()"
    (pageChange)="handlePageChange($event)"
  >
  </app-paginator>
  } } @if (!isLoading() && !repositories().repositories.length) {
  <div class="no-repos">
    <mat-icon>sentiment_dissatisfied</mat-icon>
    <p>No se encontraron repositorios para este usuario.</p>
  </div>
  }
</div>
